/**
 * è´¦æˆ·ç®¡ç†é¡µé¢
 */
import { AccountService } from '../service/AccountService'
import { Account, AccountType } from '../model/Account'
import { router } from '@kit.ArkUI'

// è´¦æˆ·ç±»å‹é€‰é¡¹æ¥å£
interface AccountTypeOption {
  type: AccountType
  name: string
  icon: string
}

@Entry
@ComponentV2
export struct AccountManagePage {
  @Local accounts: Account[] = []
  @Local showAddDialog: boolean = false
  @Local editingAccount: Account | null = null
  @Local newAccountName: string = ''
  @Local newAccountType: AccountType = AccountType.CASH
  @Local newAccountBalance: string = ''
  
  private accountService = AccountService.getInstance()

  aboutToAppear(): void {
    this.loadAccounts()
  }

  // åŠ è½½è´¦æˆ·åˆ—è¡¨
  private async loadAccounts(): Promise<void> {
    this.accounts = await this.accountService.getAllAccounts()
  }

  // æ·»åŠ è´¦æˆ·
  private async addAccount(): Promise<void> {
    if (!this.newAccountName.trim()) {
      return
    }

    const account = new Account(
      this.newAccountName.trim(),
      this.newAccountType,
      parseFloat(this.newAccountBalance) || 0
    )

    const success = await this.accountService.addAccount(account)
    if (success) {
      await this.loadAccounts()
      this.resetForm()
      this.showAddDialog = false
    }
  }

  // è®¾ç½®é»˜è®¤è´¦æˆ·
  private async setDefaultAccount(accountId: number): Promise<void> {
    const success = await this.accountService.setDefaultAccount(accountId)
    if (success) {
      await this.loadAccounts()
    }
  }

  // åˆ é™¤è´¦æˆ·
  private async deleteAccount(accountId: number): Promise<void> {
    const success = await this.accountService.deleteAccount(accountId)
    if (success) {
      await this.loadAccounts()
    }
  }

  // é‡ç½®è¡¨å•
  private resetForm(): void {
    this.newAccountName = ''
    this.newAccountType = AccountType.CASH
    this.newAccountBalance = ''
    this.editingAccount = null
  }

  // è¿”å›ä¸Šä¸€é¡µ
  private goBack(): void {
    router.back()
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()
      
      // è´¦æˆ·åˆ—è¡¨
      this.buildAccountList()
      
      // æ·»åŠ æŒ‰é’®
      this.buildAddButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
    .bindSheet($$this.showAddDialog, this.buildAddAccountDialog, {
      height: 400,
      dragBar: true
    })
  }

  // æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
  @Builder
  buildHeader() {
    Row() {
      Image($r('sys.symbol.chevron_left'))
        .width(24)
        .height(24)
        .fillColor($r('app.color.text_primary'))
        .onClick(() => {
          this.goBack()
        })
      
      Text('è´¦æˆ·ç®¡ç†')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      // å ä½
      Blank()
        .width(24)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.white'))
  }

  // æ„å»ºè´¦æˆ·åˆ—è¡¨
  @Builder
  buildAccountList() {
    if (this.accounts.length === 0) {
      Column() {
        Text('ğŸ»')
          .fontSize(48)
          .margin({ bottom: 16 })
        
        Text('è¿˜æ²¡æœ‰è´¦æˆ·')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
          .margin({ bottom: 8 })
        
        Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªè´¦æˆ·')
          .fontSize(14)
          .fontColor($r('app.color.text_hint'))
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.Center)
      .margin({ top: 60 })
    } else {
      List() {
        ForEach(this.accounts, (account: Account) => {
          ListItem() {
            this.buildAccountItem(account)
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ top: 8 })
    }
  }

  // æ„å»ºè´¦æˆ·é¡¹
  @Builder
  buildAccountItem(account: Account) {
    Row() {
      // è´¦æˆ·å›¾æ ‡
      Text(account.icon || account.getDefaultIcon())
        .fontSize(24)
        .width(40)
        .height(40)
        .textAlign(TextAlign.Center)
        .backgroundColor(account.color || account.getDefaultColor())
        .borderRadius(20)
        .fontColor($r('app.color.white'))
      
      // è´¦æˆ·ä¿¡æ¯
      Column() {
        Row() {
          Text(account.name)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
          
          if (account.isDefault) {
            Text('é»˜è®¤')
              .fontSize(12)
              .fontColor($r('app.color.white'))
              .backgroundColor($r('app.color.primary_color'))
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8)
              .margin({ left: 8 })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        
        Row() {
          Text(account.getTypeDisplayName())
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
          
          Text(`Â¥${account.balance.toFixed(2)}`)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor(account.balance >= 0 ? $r('app.color.income_color') : $r('app.color.expense_color'))
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .margin({ top: 4 })
      }
      .layoutWeight(1)
      .margin({ left: 12 })
      .alignItems(HorizontalAlign.Start)
      
      // æ“ä½œæŒ‰é’®
      Row() {
        if (!account.isDefault) {
          Button('è®¾ä¸ºé»˜è®¤')
            .fontSize(12)
            .backgroundColor($r('app.color.primary_color'))
            .borderRadius(12)
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .onClick(() => {
              this.setDefaultAccount(account.id)
            })
        }
        
        Button('åˆ é™¤')
          .fontSize(12)
          .backgroundColor($r('app.color.expense_color'))
          .borderRadius(12)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .margin({ left: 8 })
          .onClick(() => {
            this.deleteAccount(account.id)
          })
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.white'))
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 8 })
  }

  // æ„å»ºæ·»åŠ æŒ‰é’®
  @Builder
  buildAddButton() {
    Button('æ·»åŠ è´¦æˆ·')
      .width('calc(100% - 32px)')
      .height(48)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .backgroundColor($r('app.color.primary_color'))
      .borderRadius(24)
      .margin({ left: 16, right: 16, bottom: 32 })
      .onClick(() => {
        this.resetForm()
        this.showAddDialog = true
      })
  }

  // æ„å»ºæ·»åŠ è´¦æˆ·å¯¹è¯æ¡†
  @Builder
  buildAddAccountDialog() {
    Column() {
      Text('æ·»åŠ è´¦æˆ·')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 24 })
      
      // è´¦æˆ·åç§°
      Column() {
        Text('è´¦æˆ·åç§°')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        TextInput({ placeholder: 'è¯·è¾“å…¥è´¦æˆ·åç§°', text: this.newAccountName })
          .width('100%')
          .height(44)
          .backgroundColor($r('app.color.input_background'))
          .borderRadius(8)
          .onChange((value: string) => {
            this.newAccountName = value
          })
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // è´¦æˆ·ç±»å‹
      Column() {
        Text('è´¦æˆ·ç±»å‹')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        Row() {
          ForEach([
            { type: AccountType.CASH, name: 'ç°é‡‘', icon: 'ğŸ’°' },
            { type: AccountType.ALIPAY, name: 'æ”¯ä»˜å®', icon: 'ğŸ”µ' },
            { type: AccountType.WECHAT, name: 'å¾®ä¿¡', icon: 'ğŸŸ¢' },
            { type: AccountType.BANK_CARD, name: 'é“¶è¡Œå¡', icon: 'ğŸ¦' }
          ], (item: AccountTypeOption) => {
            Column() {
              Text(item.icon)
                .fontSize(20)
                .margin({ bottom: 4 })
              
              Text(item.name)
                .fontSize(12)
                .fontColor(this.newAccountType === item.type ? 
                  $r('app.color.primary_color') : $r('app.color.text_secondary'))
            }
            .width(60)
            .height(60)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.newAccountType === item.type ? 
              $r('app.color.primary_light') : $r('app.color.input_background'))
            .borderRadius(8)
            .border({
              width: this.newAccountType === item.type ? 2 : 0,
              color: $r('app.color.primary_color')
            })
            .onClick(() => {
              this.newAccountType = item.type
            })
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      // åˆå§‹ä½™é¢
      Column() {
        Text('åˆå§‹ä½™é¢')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
          .margin({ bottom: 8 })
        
        TextInput({ placeholder: 'è¯·è¾“å…¥åˆå§‹ä½™é¢', text: this.newAccountBalance })
          .width('100%')
          .height(44)
          .backgroundColor($r('app.color.input_background'))
          .borderRadius(8)
          .type(InputType.Number)
          .onChange((value: string) => {
            this.newAccountBalance = value
          })
      }
      .width('100%')
      .margin({ bottom: 24 })
      
      // æ“ä½œæŒ‰é’®
      Row() {
        Button('å–æ¶ˆ')
          .width('calc(50% - 8px)')
          .height(44)
          .backgroundColor($r('app.color.button_secondary'))
          .fontColor($r('app.color.text_primary'))
          .borderRadius(22)
          .onClick(() => {
            this.showAddDialog = false
          })
        
        Button('ç¡®å®š')
          .width('calc(50% - 8px)')
          .height(44)
          .backgroundColor($r('app.color.primary_color'))
          .borderRadius(22)
          .onClick(() => {
            this.addAccount()
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .padding(20)
  }
}