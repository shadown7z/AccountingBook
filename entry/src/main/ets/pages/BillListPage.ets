import { BillService } from '../service/BillService'
import { BillRecord, BillType } from '../model/BillRecord'
import { router } from '@kit.ArkUI'

@Entry
@ComponentV2
export struct BillListPage {
  @Local billService: BillService = BillService.getInstance()
  @Local billRecords: BillRecord[] = []
  @Local selectedMonth: string = ''
  @Local showMonthPicker: boolean = false
  @Local monthlyIncome: number = 0
  @Local monthlyExpense: number = 0

  aboutToAppear() {
    this.selectedMonth = new Date().toISOString().slice(0, 7) // YYYY-MM
    this.loadBillRecords()
  }

  private loadBillRecords() {
    const allRecords = this.billService.getBillRecords()
    this.billRecords = allRecords.filter(record => record.date.startsWith(this.selectedMonth))
    this.calculateMonthlyStats()
  }

  private calculateMonthlyStats() {
    this.monthlyIncome = this.billRecords
      .filter(record => record.type === BillType.INCOME)
      .reduce((sum, record) => sum + record.amount, 0)
    
    this.monthlyExpense = this.billRecords
      .filter(record => record.type === BillType.EXPENSE)
      .reduce((sum, record) => sum + record.amount, 0)
  }

  private formatMonth(month: string): string {
    const date = new Date(month + '-01')
    return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`
  }

  private generateMonthOptions(): string[] {
    const months: string[] = []
    const currentDate = new Date()
    
    // ç”Ÿæˆè¿‡å»12ä¸ªæœˆçš„é€‰é¡¹
    for (let i = 0; i < 12; i++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1)
      const monthStr = date.toISOString().slice(0, 7)
      months.push(monthStr)
    }
    
    return months
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildHeader()
      
      // æœˆåº¦ç»Ÿè®¡
      this.buildMonthlyStats()
      
      // è´¦å•åˆ—è¡¨
      this.buildBillList()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
    .bindSheet($$this.showMonthPicker, this.buildMonthPicker(), {
      height: 300
    })
  }

  // æ„å»ºé¡¶éƒ¨å¯¼èˆªæ 
  @Builder
  buildHeader() {
    Row() {
      Text('è¿”å›')
        .fontSize(16)
        .fontColor($r('app.color.text_primary'))
        .onClick(() => {
          router.back()
        })
      
      Blank()
      
      Row({ space: 4 }) {
        Text(this.formatMonth(this.selectedMonth))
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
        
        Text('â–¼')
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
      }
      .onClick(() => {
        this.showMonthPicker = true
      })
      
      Blank()
      
      Text('')
        .width(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.card_background'))
  }

  // æ„å»ºæœˆåº¦ç»Ÿè®¡
  @Builder
  buildMonthlyStats() {
    Row() {
      // æ”¶å…¥
      Column({ space: 4 }) {
        Text($r('app.string.income'))
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
        
        Text(`Â¥${BillService.formatAmount(this.monthlyIncome)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.income_color'))
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // åˆ†å‰²çº¿
      Divider()
        .vertical(true)
        .height(40)
        .color($r('app.color.divider_color'))
      
      // æ”¯å‡º
      Column({ space: 4 }) {
        Text($r('app.string.expense'))
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
        
        Text(`Â¥${BillService.formatAmount(this.monthlyExpense)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.expense_color'))
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
      
      // åˆ†å‰²çº¿
      Divider()
        .vertical(true)
        .height(40)
        .color($r('app.color.divider_color'))
      
      // ç»“ä½™
      Column({ space: 4 }) {
        Text('ç»“ä½™')
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
        
        Text(`Â¥${BillService.formatAmount(this.monthlyIncome - this.monthlyExpense)}`)
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .padding(16)
    .margin({ left: 16, right: 16, top: 16 })
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  // æ„å»ºè´¦å•åˆ—è¡¨
  @Builder
  buildBillList() {
    if (this.billRecords.length > 0) {
      List({ space: 8 }) {
        ForEach(this.billRecords, (record: BillRecord) => {
          ListItem() {
            this.buildBillItem(record)
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    } else {
      // ç©ºçŠ¶æ€
      Column({ space: 16 }) {
        Text('ğŸ»')
          .fontSize(48)
        
        Text('æœ¬æœˆæš‚æ— è®°å½•')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
        
        Text('å¿«å»è®°å½•ç¬¬ä¸€ç¬”è´¦å•å§~')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
  }

  // æ„å»ºå•ä¸ªè´¦å•é¡¹
  @Builder
  buildBillItem(record: BillRecord) {
    Row({ space: 12 }) {
      // åˆ†ç±»å›¾æ ‡
      Stack() {
        Text(this.getCategoryIcon(record.category))
          .fontSize(24)
          .width(48)
          .height(48)
          .textAlign(TextAlign.Center)
          .backgroundColor($r('app.color.background_color'))
          .borderRadius(24)
        
        // é¢œè‰²æŒ‡ç¤ºå™¨
        Circle({ width: 12, height: 12 })
          .fill(this.getCategoryColor(record.category))
          .stroke(Color.White)
          .strokeWidth(1)
          .position({ x: 36, y: 36 })
      }
      .width(48)
      .height(48)
      
      // è®°å½•ä¿¡æ¯
      Column({ space: 4 }) {
        Row() {
          Text(record.category)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor($r('app.color.text_primary'))
          
          if (record.note) {
            Text(`Â·${record.note}`)
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .layoutWeight(1)
          }
        }
        .width('100%')
        
        Row({ space: 8 }) {
          Text(this.formatDate(record.date))
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
          
          Text(this.formatTime(record.createTime))
            .fontSize(12)
            .fontColor($r('app.color.text_secondary'))
        }
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
      // é‡‘é¢
      Text(`${record.type === BillType.INCOME ? '+' : '-'}Â¥${BillService.formatAmount(record.amount)}`)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(record.type === BillType.INCOME ? $r('app.color.income_color') : $r('app.color.expense_color'))
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#0A000000',
      offsetX: 0,
      offsetY: 1
    })
  }

  // æ„å»ºæœˆä»½é€‰æ‹©å™¨
  @Builder
  buildMonthPicker() {
    Column({ space: 16 }) {
      Text('é€‰æ‹©æœˆä»½')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      List({ space: 8 }) {
        ForEach(this.generateMonthOptions(), (month: string) => {
          ListItem() {
            Row() {
              Text(this.formatMonth(month))
                .fontSize(16)
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
              
              if (month === this.selectedMonth) {
                Text('âœ“')
                  .fontSize(16)
                  .fontColor($r('app.color.primary_color'))
              }
            }
            .width('100%')
            .padding(12)
            .backgroundColor(month === this.selectedMonth ? $r('app.color.background_color') : Color.Transparent)
            .borderRadius(8)
            .onClick(() => {
              this.selectedMonth = month
              this.loadBillRecords()
              this.showMonthPicker = false
            })
          }
        })
      }
      .width('100%')
      .height(200)
    }
    .padding(20)
    .backgroundColor($r('app.color.card_background'))
  }

  // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
  private formatDate(dateStr: string): string {
    const date = new Date(dateStr)
    const today = new Date()
    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000)
    
    if (dateStr === today.toISOString().split('T')[0]) {
      return 'ä»Šå¤©'
    } else if (dateStr === yesterday.toISOString().split('T')[0]) {
      return 'æ˜¨å¤©'
    } else {
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
  private formatTime(timeStr: string): string {
    const date = new Date(timeStr)
    return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }

  // è·å–åˆ†ç±»å›¾æ ‡
  private getCategoryIcon(category: string): string {
    const iconMap: Record<string, string> = {
      'é¤é¥®': 'ğŸ½ï¸',
      'äº¤é€š': 'ğŸš—',
      'è´­ç‰©': 'ğŸ›’',
      'å¨±ä¹': 'ğŸ®',
      'åŒ»ç–—': 'ğŸ¥',
      'æ•™è‚²': 'ğŸ“š',
      'ä½æˆ¿': 'ğŸ ',
      'å·¥èµ„': 'ğŸ’°',
      'å¥–é‡‘': 'ğŸ',
      'æŠ•èµ„': 'ğŸ“ˆ',
      'å…¼èŒ': 'ğŸ’¼',
      'å…¶ä»–': 'ğŸ“'
    }
    return iconMap[category] || 'ğŸ“'
  }

  // è·å–åˆ†ç±»é¢œè‰²
  private getCategoryColor(category: string): string {
    const categories = this.billService.getCategories(BillType.EXPENSE).concat(this.billService.getCategories(BillType.INCOME))
    const categoryObj = categories.find(cat => cat.name === category)
    return categoryObj?.color || '#FF6B6B'
  }
}