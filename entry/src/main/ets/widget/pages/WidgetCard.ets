import { WidgetService, WidgetData } from '../../service/WidgetService'

/**
 * æ¡Œé¢å¡ç‰‡UIç»„ä»¶
 * æä¾›å¿«é€Ÿè®°è´¦å’Œæ•°æ®å±•ç¤ºåŠŸèƒ½
 */
@Entry
@Component
struct WidgetCard {
  @State widgetData: WidgetData = this.getDefaultWidgetData()
  
  @State showQuickActions: boolean = false
  @State quickAmount: string = ''
  
  private widgetService = WidgetService.getInstance()
  
  aboutToAppear(): void {
    this.loadWidgetData()
  }
  
  // åŠ è½½å¡ç‰‡æ•°æ®
  async loadWidgetData() {
    try {
      this.widgetData = await this.widgetService.getWidgetData()
    } catch (error) {
      console.error('Failed to load widget data:', error)
    }
  }
  
  // è·å–é»˜è®¤å¡ç‰‡æ•°æ®
  private getDefaultWidgetData(): WidgetData {
    const defaultData: WidgetData = {
      todayIncome: 0,
      todayExpense: 0,
      monthIncome: 0,
      monthExpense: 0,
      totalBalance: 0,
      recentBills: [],
      lastUpdateTime: ''
    }
    return defaultData
  }
  
  // å¿«é€Ÿæ·»åŠ æ”¶å…¥
  async quickAddIncome(amount: number) {
    try {
      const success = await this.widgetService.quickAddIncome(amount)
      if (success) {
        await this.loadWidgetData()
        const actionData: Record<string, Object> = {}
        actionData['amount'] = amount
        actionData['success'] = true
        this.postAction('quickIncome', actionData)
      }
    } catch (error) {
      console.error('Failed to quick add income:', error)
    }
  }
  
  // å¿«é€Ÿæ·»åŠ æ”¯å‡º
  async quickAddExpense(amount: number) {
    try {
      const success = await this.widgetService.quickAddExpense(amount)
      if (success) {
        await this.loadWidgetData()
        const actionData: Record<string, Object> = {}
        actionData['amount'] = amount
        actionData['success'] = true
        this.postAction('quickExpense', actionData)
      }
    } catch (error) {
      console.error('Failed to quick add expense:', error)
    }
  }
  
  // å‘é€å¡ç‰‡äº‹ä»¶
  private postAction(action: string, data: Record<string, Object>) {
    try {
      // å¡ç‰‡äº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼ä¸ä¸»åº”ç”¨é€šä¿¡
      console.info(`Widget action: ${action}`, data)
    } catch (error) {
      console.error('Failed to post card action:', error)
    }
  }
  
  // æ ¼å¼åŒ–é‡‘é¢
  private formatAmount(amount: number): string {
    return amount.toFixed(2)
  }
  
  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(): string {
    const now = new Date()
    return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`
  }
  
  // è·å–æœ¬æœˆç»“ä½™
  private getMonthBalance(): number {
    return this.widgetData.monthIncome - this.widgetData.monthExpense
  }
  
  build() {
    Column() {
      // å¤´éƒ¨ä¿¡æ¯
      this.buildHeader()
      
      // ä»Šæ—¥æ•°æ®
      this.buildTodayData()
      
      // å¿«é€Ÿæ“ä½œ
      this.buildQuickActions()
      
      // ä½™é¢ä¿¡æ¯
      this.buildBalanceInfo()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .padding(16)
  }
  
  // å¡ç‰‡å¤´éƒ¨
  @Builder
  buildHeader() {
    Row() {
      Text('ğŸ» ç†Šå®è®°è´¦')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
        .layoutWeight(1)
      
      Text(this.formatTime())
        .fontSize(12)
        .fontColor('#999999')
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
  
  // ä»Šæ—¥æ•°æ®
  @Builder
  buildTodayData() {
    Row() {
      // ä»Šæ—¥æ”¶å…¥
      Column() {
        Text('ä»Šæ—¥æ”¶å…¥')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ bottom: 4 })
        
        Text(`+${this.formatAmount(this.widgetData.todayIncome)}`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#4CAF50')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // ä»Šæ—¥æ”¯å‡º
      Column() {
        Text('ä»Šæ—¥æ”¯å‡º')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ bottom: 4 })
        
        Text(`-${this.formatAmount(this.widgetData.todayExpense)}`)
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FF5722')
      }
      .alignItems(HorizontalAlign.End)
      .layoutWeight(1)
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
  
  // å¿«é€Ÿæ“ä½œ
  @Builder
  buildQuickActions() {
    Row({ space: 8 }) {
      // å¿«é€Ÿæ”¶å…¥æŒ‰é’®
      Button() {
        Row() {
          Text('ğŸ’°')
            .fontSize(12)
            .margin({ right: 4 })
          Text('æ”¶å…¥')
            .fontSize(10)
            .fontColor('#FFFFFF')
        }
      }
      .backgroundColor('#4CAF50')
      .borderRadius(8)
      .padding({ left: 8, right: 8, top: 6, bottom: 6 })
      .layoutWeight(1)
      .onClick(() => {
        this.quickAddIncome(100) // é»˜è®¤100å…ƒ
      })
      
      // å¿«é€Ÿæ”¯å‡ºæŒ‰é’®
      Button() {
        Row() {
          Text('ğŸ’¸')
            .fontSize(12)
            .margin({ right: 4 })
          Text('æ”¯å‡º')
            .fontSize(10)
            .fontColor('#FFFFFF')
        }
      }
      .backgroundColor('#FF5722')
      .borderRadius(8)
      .padding({ left: 8, right: 8, top: 6, bottom: 6 })
      .layoutWeight(1)
      .onClick(() => {
        this.quickAddExpense(50) // é»˜è®¤50å…ƒ
      })
      
      // æ‰“å¼€åº”ç”¨æŒ‰é’®
      Button() {
        Row() {
          Text('ğŸ“±')
            .fontSize(12)
            .margin({ right: 4 })
          Text('æ‰“å¼€')
            .fontSize(10)
            .fontColor('#FFFFFF')
        }
      }
      .backgroundColor('#2196F3')
      .borderRadius(8)
      .padding({ left: 8, right: 8, top: 6, bottom: 6 })
      .layoutWeight(1)
      .onClick(() => {
        // æ‰“å¼€ä¸»åº”ç”¨
        this.postAction('openApp', {})
      })
    }
    .width('100%')
    .margin({ bottom: 12 })
  }
  
  // ä½™é¢ä¿¡æ¯
  @Builder
  buildBalanceInfo() {
    Row() {
      Column() {
        Text('è´¦æˆ·ä½™é¢')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ bottom: 4 })
        
        Text(`Â¥${this.formatAmount(this.widgetData.totalBalance)}`)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1)
      
      // æœ¬æœˆç»Ÿè®¡
      Column() {
        Text('æœ¬æœˆç»“ä½™')
          .fontSize(10)
          .fontColor('#666666')
          .margin({ bottom: 4 })
        
        Text(`${this.getMonthBalance() >= 0 ? '+' : ''}${this.formatAmount(this.getMonthBalance())}`)
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.getMonthBalance() >= 0 ? '#4CAF50' : '#FF5722')
      }
      .alignItems(HorizontalAlign.End)
      .layoutWeight(1)
    }
    .width('100%')
  }
}