// åˆ†ç±»ç®¡ç†é¡µé¢
import { HMRouter } from '@hadss/hmrouter'
import { BillService } from '../service/BillService'
import { BillCategory, BillType } from '../model/BillRecord'
import { PagePath } from '../constants/PagePath'

@Entry
@HMRouter({ pageUrl: PagePath.CATEGORY_MANAGE })
@ComponentV2
export struct CategoryManagePage {
  private billService = BillService.getInstance()
  @Local categories: BillCategory[] = []
  @Local currentType: BillType = BillType.EXPENSE
  @Local showAddDialog: boolean = false
  @Local showEditDialog: boolean = false
  @Local editingCategory: BillCategory | null = null
  @Local newCategoryName: string = ''
  @Local newCategoryIcon: string = 'ğŸ“'
  @Local newCategoryColor: string = '#FF6B6B'
  
  // å¸¸ç”¨å›¾æ ‡åˆ—è¡¨
  private readonly commonIcons: string[] = [
    'ğŸ½ï¸', 'ğŸš—', 'ğŸ›’', 'ğŸ®', 'ğŸ¥', 'ğŸ“š', 'ğŸ ', 'ğŸ’°',
    'ğŸ', 'ğŸ“ˆ', 'ğŸ’¼', 'ğŸ“', 'â˜•', 'ğŸ¬', 'ğŸ‘•', 'ğŸ’Š',
    'â›½', 'ğŸ“±', 'ğŸ’¡', 'ğŸµ', 'ğŸƒ', 'âœˆï¸', 'ğŸ‚', 'ğŸŒŸ'
  ]
  
  // å¸¸ç”¨é¢œè‰²åˆ—è¡¨
  private readonly commonColors: string[] = [
    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
    '#DDA0DD', '#98D8C8', '#F7DC6F', '#58D68D', '#F8C471',
    '#85C1E9', '#BB8FCE', '#82E0AA', '#F1948A', '#85C1E9'
  ]

  aboutToAppear() {
    this.loadCategories()
  }

  // åŠ è½½åˆ†ç±»æ•°æ®
  private loadCategories() {
    this.categories = this.billService.getCategories(this.currentType)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildNavigationBar()
      
      // ç±»å‹åˆ‡æ¢æ ‡ç­¾
      this.buildTypeSelector()
      
      // åˆ†ç±»åˆ—è¡¨
      this.buildCategoryList()
      
      // æ·»åŠ æŒ‰é’®
      this.buildAddButton()
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
    .bindSheet($$this.showAddDialog, this.addCategoryDialog, {
      height: 400,
      dragBar: true
    })
    .bindSheet($$this.showEditDialog, this.editCategoryDialog, {
      height: 400,
      dragBar: true
    })
  }

  // æ„å»ºå¯¼èˆªæ 
  @Builder
  buildNavigationBar() {
    Row() {
      Button('è¿”å›')
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .fontColor($r('app.color.primary_color'))
        .onClick(() => {
          // è¿”å›ä¸Šä¸€é¡µ
        })
      
      Text('åˆ†ç±»ç®¡ç†')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
        .textAlign(TextAlign.Center)
      
      // å ä½
      Button()
        .type(ButtonType.Normal)
        .backgroundColor(Color.Transparent)
        .width(60)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.card_background'))
  }

  // æ„å»ºç±»å‹é€‰æ‹©å™¨
  @Builder
  buildTypeSelector() {
    Row() {
      Button('æ”¯å‡º')
        .type(ButtonType.Normal)
        .backgroundColor(this.currentType === BillType.EXPENSE ? $r('app.color.primary_color') : Color.Transparent)
        .fontColor(this.currentType === BillType.EXPENSE ? Color.White : $r('app.color.text_secondary'))
        .borderRadius(20)
        .layoutWeight(1)
        .onClick(() => {
          this.currentType = BillType.EXPENSE
          this.loadCategories()
        })
      
      Button('æ”¶å…¥')
        .type(ButtonType.Normal)
        .backgroundColor(this.currentType === BillType.INCOME ? $r('app.color.primary_color') : Color.Transparent)
        .fontColor(this.currentType === BillType.INCOME ? Color.White : $r('app.color.text_secondary'))
        .borderRadius(20)
        .layoutWeight(1)
        .onClick(() => {
          this.currentType = BillType.INCOME
          this.loadCategories()
        })
    }
    .width('100%')
    .height(44)
    .padding({ left: 16, right: 16, top: 8, bottom: 8 })
    .backgroundColor($r('app.color.background_color'))
  }

  // æ„å»ºåˆ†ç±»åˆ—è¡¨
  @Builder
  buildCategoryList() {
    if (this.categories.length > 0) {
      List({ space: 8 }) {
        ForEach(this.categories, (category: BillCategory) => {
          ListItem() {
            this.buildCategoryItem(category)
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 8 })
    } else {
      Column({ space: 16 }) {
        Text('ğŸ»')
          .fontSize(48)
        
        Text('æš‚æ— åˆ†ç±»')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
        
        Text('å¿«å»æ·»åŠ ç¬¬ä¸€ä¸ªåˆ†ç±»å§~')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
      }
      .layoutWeight(1)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
  }

  // æ„å»ºåˆ†ç±»é¡¹
  @Builder
  buildCategoryItem(category: BillCategory) {
    Row({ space: 12 }) {
      // åˆ†ç±»å›¾æ ‡å’Œé¢œè‰²
      Stack() {
        Text(category.icon)
          .fontSize(24)
          .width(48)
          .height(48)
          .textAlign(TextAlign.Center)
          .backgroundColor($r('app.color.icon_background'))
          .borderRadius(24)
        
        // é¢œè‰²æŒ‡ç¤ºå™¨
        Circle({ width: 12, height: 12 })
          .fill(category.color)
          .position({ x: 36, y: 36 })
          .border({ width: 2, color: Color.White })
      }
      .width(48)
      .height(48)
      
      // åˆ†ç±»ä¿¡æ¯
      Column({ space: 4 }) {
        Row() {
          Text(category.name)
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
          
          if (category.isDefault) {
            Text('é»˜è®¤')
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .backgroundColor($r('app.color.tag_background'))
              .borderRadius(10)
          }
        }
        .width('100%')
        
        Text(category.type === BillType.EXPENSE ? 'æ”¯å‡ºåˆ†ç±»' : 'æ”¶å…¥åˆ†ç±»')
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      
      // æ“ä½œæŒ‰é’®
      if (!category.isDefault) {
        Row({ space: 8 }) {
          Button('ç¼–è¾‘')
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.primary_color'))
            .fontColor(Color.White)
            .fontSize(12)
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .onClick(() => {
              this.editingCategory = category
              this.newCategoryName = category.name
              this.newCategoryIcon = category.icon
              this.newCategoryColor = category.color
              this.showEditDialog = true
            })
          
          Button('åˆ é™¤')
            .type(ButtonType.Normal)
            .backgroundColor($r('app.color.error_color'))
            .fontColor(Color.White)
            .fontSize(12)
            .borderRadius(16)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .onClick(() => {
              this.deleteCategory(category)
            })
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#1A000000',
      offsetX: 0,
      offsetY: 1
    })
  }

  // æ„å»ºæ·»åŠ æŒ‰é’®
  @Builder
  buildAddButton() {
    Button('æ·»åŠ åˆ†ç±»')
      .type(ButtonType.Normal)
      .backgroundColor($r('app.color.primary_color'))
      .fontColor(Color.White)
      .fontSize(16)
      .borderRadius(24)
      .width('100%')
      .height(48)
      .margin({ left: 16, right: 16, bottom: 16 })
      .onClick(() => {
        this.newCategoryName = ''
        this.newCategoryIcon = 'ğŸ“'
        this.showAddDialog = true
      })
  }

  // æ·»åŠ åˆ†ç±»å¯¹è¯æ¡†
  @Builder
  addCategoryDialog() {
    Column({ space: 20 }) {
      Text('æ·»åŠ åˆ†ç±»')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      // åˆ†ç±»åç§°è¾“å…¥
      Column({ space: 8 }) {
        Text('åˆ†ç±»åç§°')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: $$this.newCategoryName })
          .fontSize(16)
          .borderRadius(8)
          .backgroundColor($r('app.color.input_background'))
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // å›¾æ ‡é€‰æ‹©
      Column({ space: 8 }) {
        Text('é€‰æ‹©å›¾æ ‡')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        Grid() {
          ForEach(this.commonIcons, (icon: string) => {
            GridItem() {
              Text(icon)
                .fontSize(24)
                .width(48)
                .height(48)
                .textAlign(TextAlign.Center)
                .backgroundColor(this.newCategoryIcon === icon ? $r('app.color.primary_color') : $r('app.color.icon_background'))
                .borderRadius(24)
                .onClick(() => {
                  this.newCategoryIcon = icon
                })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
        .height(120)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // é¢œè‰²é€‰æ‹©
      Column({ space: 8 }) {
        Text('é€‰æ‹©é¢œè‰²')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        Grid() {
          ForEach(this.commonColors, (color: string) => {
            GridItem() {
              Circle({ width: 36, height: 36 })
                .fill(color)
                .border({
                  width: this.newCategoryColor === color ? 3 : 1,
                  color: this.newCategoryColor === color ? '#333333' : '#E0E0E0'
                })
                .onClick(() => {
                  this.newCategoryColor = color
                })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
        .height(80)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // é¢œè‰²é€‰æ‹©
      Column({ space: 8 }) {
        Text('é€‰æ‹©é¢œè‰²')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        Grid() {
          ForEach(this.commonColors, (color: string) => {
            GridItem() {
              Circle({ width: 32, height: 32 })
                .fill(color)
                .stroke(this.newCategoryColor === color ? $r('app.color.primary_color') : Color.Transparent)
                .strokeWidth(this.newCategoryColor === color ? 3 : 0)
                .onClick(() => {
                  this.newCategoryColor = color
                })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
        .height(60)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor($r('app.color.button_secondary'))
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
          .onClick(() => {
            this.showAddDialog = false
          })
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor($r('app.color.primary_color'))
          .fontColor(Color.White)
          .layoutWeight(1)
          .onClick(() => {
            this.addCategory()
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
  }

  // ç¼–è¾‘åˆ†ç±»å¯¹è¯æ¡†
  @Builder
  editCategoryDialog() {
    Column({ space: 20 }) {
      Text('ç¼–è¾‘åˆ†ç±»')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      // åˆ†ç±»åç§°è¾“å…¥
      Column({ space: 8 }) {
        Text('åˆ†ç±»åç§°')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: $$this.newCategoryName })
          .fontSize(16)
          .borderRadius(8)
          .backgroundColor($r('app.color.input_background'))
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // å›¾æ ‡é€‰æ‹©
      Column({ space: 8 }) {
        Text('é€‰æ‹©å›¾æ ‡')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .alignSelf(ItemAlign.Start)
        
        Grid() {
          ForEach(this.commonIcons, (icon: string) => {
            GridItem() {
              Text(icon)
                .fontSize(24)
                .width(48)
                .height(48)
                .textAlign(TextAlign.Center)
                .backgroundColor(this.newCategoryIcon === icon ? $r('app.color.primary_color') : $r('app.color.icon_background'))
                .borderRadius(24)
                .onClick(() => {
                  this.newCategoryIcon = icon
                })
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr 1fr 1fr 1fr')
        .rowsGap(8)
        .columnsGap(8)
        .width('100%')
        .height(120)
      }
      .width('100%')
      .alignItems(HorizontalAlign.Start)
      
      // æ“ä½œæŒ‰é’®
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .type(ButtonType.Normal)
          .backgroundColor($r('app.color.button_secondary'))
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
          .onClick(() => {
            this.showEditDialog = false
          })
        
        Button('ç¡®å®š')
          .type(ButtonType.Normal)
          .backgroundColor($r('app.color.primary_color'))
          .fontColor(Color.White)
          .layoutWeight(1)
          .onClick(() => {
            this.updateCategory()
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
  }

  // æ·»åŠ åˆ†ç±»
  private async addCategory() {
    if (!this.newCategoryName.trim()) {
      // æ˜¾ç¤ºæç¤º
      return
    }

    const newCategory = new BillCategory(
      this.newCategoryName.trim(),
      this.newCategoryIcon,
      this.currentType,
      false,
      this.newCategoryColor
    )

    const success = await this.billService.addCategory(newCategory)
    if (success) {
      this.loadCategories()
      this.showAddDialog = false
      // æ˜¾ç¤ºæˆåŠŸæç¤º
    } else {
      // æ˜¾ç¤ºå¤±è´¥æç¤º
    }
  }

  // æ›´æ–°åˆ†ç±»
  private async updateCategory() {
    if (!this.editingCategory || !this.newCategoryName.trim()) {
      return
    }

    this.editingCategory.name = this.newCategoryName.trim()
    this.editingCategory.icon = this.newCategoryIcon
    this.editingCategory.color = this.newCategoryColor

    const success = await this.billService.updateCategory(this.editingCategory)
    if (success) {
      this.loadCategories()
      this.showEditDialog = false
      this.editingCategory = null
      // æ˜¾ç¤ºæˆåŠŸæç¤º
    } else {
      // æ˜¾ç¤ºå¤±è´¥æç¤º
    }
  }

  // åˆ é™¤åˆ†ç±»
  private async deleteCategory(category: BillCategory) {
    const success = await this.billService.deleteCategory(category.id)
    if (success) {
      this.loadCategories()
      // æ˜¾ç¤ºæˆåŠŸæç¤º
    } else {
      // æ˜¾ç¤ºå¤±è´¥æç¤º
    }
  }
}