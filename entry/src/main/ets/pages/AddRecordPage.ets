import { BillService } from '../service/BillService'
import { BillRecord, BillType, BillCategory } from '../model/BillRecord'
import { AccountService } from '../service/AccountService'
import { Account } from '../model/Account'
import { PagePath } from '../constants/PagePath'
import { router } from '@kit.ArkUI'

@Entry
@ComponentV2
export struct AddRecordPage {
  @Local billService: BillService = BillService.getInstance()
  @Local currentType: BillType = BillType.EXPENSE
  @Local amount: string = ''
  @Local selectedCategory: string = ''
  @Local note: string = ''
  @Local categories: BillCategory[] = []
  @Local showCategoryPicker: boolean = false
  @Local selectedAccount: Account | null = null
  @Local accounts: Account[] = []
  @Local showAccountPicker: boolean = false
  @Local showKeyboard: boolean = false
  @Local keyboardOffset: number = 300
  
  private accountService = AccountService.getInstance()

  aboutToAppear() {
    this.loadCategories()
    this.loadAccounts()
  }

  // Âä†ËΩΩË¥¶Êà∑ÂàóË°®
  private async loadAccounts(): Promise<void> {
    this.accounts = await this.accountService.getAllAccounts()
    if (this.accounts.length > 0) {
      // ÈªòËÆ§ÈÄâÊã©Á¨¨‰∏Ä‰∏™Ë¥¶Êà∑
      this.selectedAccount = this.accounts[0]
    }
  }

  private loadCategories() {
    this.categories = this.billService.getCategories(this.currentType)
    if (this.categories.length > 0) {
      this.selectedCategory = this.categories[0].name
    }
  }

  private onTypeChange(type: BillType) {
    this.currentType = type
    this.loadCategories()
  }

  // ÊòæÁ§∫ÈîÆÁõòÂä®Áîª
  private showKeyboardWithAnimation() {
    if (!this.showKeyboard) {
      this.showKeyboard = true
      animateTo({
        duration: 300,
        curve: Curve.EaseOut
      }, () => {
        this.keyboardOffset = 0
      })
    }
  }

  // ÈöêËóèÈîÆÁõòÂä®Áîª
  private hideKeyboardWithAnimation() {
    if (this.showKeyboard) {
      animateTo({
        duration: 300,
        curve: Curve.EaseIn
      }, () => {
        this.keyboardOffset = 300
      })
      // Âª∂ËøüÈöêËóèÈîÆÁõòÔºåÁ≠âÂæÖÂä®ÁîªÂÆåÊàê
      setTimeout(() => {
        this.showKeyboard = false
      }, 300)
    }
  }

  private onNumberInput(num: string) {
    if (num === 'delete') {
      this.amount = this.amount.slice(0, -1)
    } else if (num === 'clear') {
      this.amount = ''
    } else if (num === '.') {
      if (!this.amount.includes('.')) {
        this.amount += num
      }
    } else {
      // ÈôêÂà∂Â∞èÊï∞ÁÇπÂêé‰∏§‰Ωç
      if (this.amount.includes('.')) {
        const parts = this.amount.split('.')
        if (parts[1].length < 2) {
          this.amount += num
        }
      } else {
        this.amount += num
      }
    }
  }

  private async saveRecord() {
    if (!this.amount || parseFloat(this.amount) <= 0 || !this.selectedAccount) {
      // TODO: ÊòæÁ§∫ÊèêÁ§∫
      return
    }

    const record = new BillRecord(
      parseFloat(this.amount),
      this.currentType,
      this.selectedCategory,
      this.note,
      this.selectedAccount.id
    )

    const success = await this.billService.addBillRecord(record)
    if (success) {
      console.info('ËÆ∞Ë¥¶ÊàêÂäüÔºåÊ°åÈù¢Âç°ÁâáÊï∞ÊçÆÂ∞ÜËá™Âä®ÂêåÊ≠•Êõ¥Êñ∞')
      this.hideKeyboardWithAnimation()
      // Âª∂ËøüËøîÂõûÔºåÁ≠âÂæÖÈîÆÁõòÈöêËóèÂä®ÁîªÂÆåÊàê
      setTimeout(() => {
        // ËøîÂõûÈ¶ñÈ°µÂπ∂‰º†ÈÄíÂà∑Êñ∞Ê†áËØÜ
        router.back({
          url: PagePath.INDEX,
          params: {
            shouldRefresh: true
          }
        })
      }, 300)
    }
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      this.buildHeader()
      
      // ÂÜÖÂÆπÂå∫Âüü
      Column({ space: 20 }) {
        // Êî∂ÊîØÁ±ªÂûãÂàáÊç¢
        this.buildTypeSelector()
        
        // ÈáëÈ¢ùÊòæÁ§∫
        this.buildAmountDisplay()
        
        // ÂàÜÁ±ªÈÄâÊã©
        this.buildCategorySelector()
        
        // Ë¥¶Êà∑ÈÄâÊã©
        this.buildAccountSelector()
        
        // Â§áÊ≥®ËæìÂÖ•
        this.buildNoteInput()
        
        // Á°ÆËÆ§ËÆ∞Ë¥¶ÊåâÈíÆ
        this.buildConfirmButton()
        
        // Êï∞Â≠óÈîÆÁõòÂ∑≤ÁßªËá≥Ë¶ÜÁõñÂ±Ç
      }
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 16, bottom: 8 })
      .onClick(() => {
        // ÁÇπÂáªÁ©∫ÁôΩÂå∫ÂüüÈöêËóèÈîÆÁõòÂíåÂºπÁ™ó
        if (this.showKeyboard) {
          this.hideKeyboardWithAnimation()
        }
        // ÂÖ≥Èó≠ÊâÄÊúâÂºπÁ™ó
        this.showCategoryPicker = false
        this.showAccountPicker = false
      })
      
      // Êï∞Â≠óÈîÆÁõòË¶ÜÁõñÂ±Ç
      if (this.showKeyboard) {
        Stack({ alignContent: Alignment.Bottom }) {
          // ÂçäÈÄèÊòéÈÅÆÁΩ©
          Column()
            .width('100%')
            .height('100%')
            .backgroundColor('rgba(0, 0, 0, 0.3)')
            .onClick(() => {
              this.hideKeyboardWithAnimation()
            })
          
          // ÈîÆÁõòÂÆπÂô®
           Column({ space: 8 }) {
            // Á¨¨‰∏ÄË°å
            Row({ space: 8 }) {
              this.buildKeyboardButton('1')
              this.buildKeyboardButton('2')
              this.buildKeyboardButton('3')
            }
            
            // Á¨¨‰∫åË°å
            Row({ space: 8 }) {
              this.buildKeyboardButton('4')
              this.buildKeyboardButton('5')
              this.buildKeyboardButton('6')
            }
            
            // Á¨¨‰∏âË°å
            Row({ space: 8 }) {
              this.buildKeyboardButton('7')
              this.buildKeyboardButton('8')
              this.buildKeyboardButton('9')
            }
            
            // Á¨¨ÂõõË°å
            Row({ space: 8 }) {
              this.buildKeyboardButton('.')
              this.buildKeyboardButton('0')
              this.buildKeyboardButton('Âà†Èô§', 'delete')
            }
            
            // Á¨¨‰∫îË°å - Á°ÆËÆ§ÊåâÈíÆ
            Row({ space: 8 }) {
              Button('Ê∏ÖÁ©∫')
                .width('30%')
                .height(48)
                .fontSize(16)
                .backgroundColor($r('app.color.card_background'))
                .fontColor($r('app.color.text_secondary'))
                .borderRadius(8)
                .onClick(() => {
                  this.onNumberInput('clear')
                })
              
              Button('Á°ÆËÆ§ËÆ∞Ë¥¶')
                .width('65%')
                .height(48)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .backgroundColor($r('app.color.primary_color'))
                .fontColor(Color.White)
                .borderRadius(8)
                .onClick(() => {
                  this.saveRecord()
                })
            }
          }
           .width('100%')
           .padding(16)
           .backgroundColor($r('app.color.card_background'))
           .borderRadius({ topLeft: 16, topRight: 16 })
           .translate({ y: this.keyboardOffset })
           .alignSelf(ItemAlign.End)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.background_color'))
  }

  // ÊûÑÂª∫È°∂ÈÉ®ÂØºËà™Ê†è
  @Builder
  buildHeader() {
    Row() {
      Text('ËøîÂõû')
        .fontSize(16)
        .fontColor($r('app.color.text_primary'))
        .onClick(() => {
          router.back()
        })
      
      Blank()
      
      Text($r('app.string.add_record'))
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      Blank()
      
      Text('')
        .width(32)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.card_background'))
  }

  // ÊûÑÂª∫Êî∂ÊîØÁ±ªÂûãÂàáÊç¢
  @Builder
  buildTypeSelector() {
    Row() {
      Button($r('app.string.expense'))
        .width('48%')
        .height(40)
        .fontSize(16)
        .backgroundColor(this.currentType === BillType.EXPENSE ? $r('app.color.expense_color') : $r('app.color.card_background'))
        .fontColor(this.currentType === BillType.EXPENSE ? Color.White : $r('app.color.text_primary'))
        .onClick(() => {
          this.onTypeChange(BillType.EXPENSE)
        })
      
      Blank()
      
      Button($r('app.string.income'))
        .width('48%')
        .height(40)
        .fontSize(16)
        .backgroundColor(this.currentType === BillType.INCOME ? $r('app.color.income_color') : $r('app.color.card_background'))
        .fontColor(this.currentType === BillType.INCOME ? Color.White : $r('app.color.text_primary'))
        .onClick(() => {
          this.onTypeChange(BillType.INCOME)
        })
    }
    .width('100%')
  }

  // ÊûÑÂª∫ÈáëÈ¢ùÊòæÁ§∫
  @Builder
  buildAmountDisplay() {
    Column({ space: 8 }) {
      Text('ÈáëÈ¢ù')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .alignSelf(ItemAlign.Start)
      
      Row() {
        Text('¬•')
          .fontSize(32)
          .fontColor($r('app.color.text_primary'))
        
        Text(this.amount || '0')
          .fontSize(32)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(8)
    .onClick(() => {
      this.showKeyboardWithAnimation()
    })
  }

  // ÊûÑÂª∫ÂàÜÁ±ªÈÄâÊã©
  @Builder
  buildCategorySelector() {
    Column({ space: 8 }) {
      Text('ÂàÜÁ±ª')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .alignSelf(ItemAlign.Start)
      
      Row({ space: 8 }) {
        Stack() {
          Text(this.getCategoryIcon(this.selectedCategory))
            .fontSize(20)
          
          // È¢úËâ≤ÊåáÁ§∫Âô®
          if (this.selectedCategory) {
            Circle({ width: 8, height: 8 })
              .fill(this.getCategoryColor(this.selectedCategory))
              .stroke(Color.White)
              .strokeWidth(1)
              .position({ x: 16, y: 16 })
          }
        }
        .width(24)
        .height(24)
        
        Text(this.selectedCategory || 'ËØ∑ÈÄâÊã©ÂàÜÁ±ª')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
        
        Text('>')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')
      .padding(12)
      .backgroundColor($r('app.color.background_color'))
      .borderRadius(8)
      .onClick(() => {
          // Á°Æ‰øùÂÖ∂‰ªñÂºπÁ™óÈÉΩÂÖ≥Èó≠
          this.showAccountPicker = false
          // ÊòæÁ§∫ÂàÜÁ±ªÈÄâÊã©ÂºπÁ™ó
          this.showCategoryPicker = true
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(8)
    .bindSheet($$this.showCategoryPicker, this.buildCategoryPicker(), {
      height: 400
    })
  }

  // ÊûÑÂª∫Â§áÊ≥®ËæìÂÖ•
  @Builder
  buildNoteInput() {
    Column({ space: 8 }) {
      Text('Â§áÊ≥®')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .alignSelf(ItemAlign.Start)
      
      TextInput({ placeholder: 'Ê∑ªÂä†Â§áÊ≥®...', text: $$this.note })
        .fontSize(16)
        .backgroundColor($r('app.color.background_color'))
        .borderRadius(8)
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(8)
  }

  // ÊûÑÂª∫Á°ÆËÆ§ËÆ∞Ë¥¶ÊåâÈíÆ
  @Builder
  buildConfirmButton() {
    Button('Á°ÆËÆ§ËÆ∞Ë¥¶')
      .width('100%')
      .height(48)
      .fontSize(16)
      .fontWeight(FontWeight.Medium)
      .backgroundColor($r('app.color.primary_color'))
      .fontColor(Color.White)
      .borderRadius(8)
      .margin({ top: 16 })
      .onClick(() => {
        this.saveRecord()
      })
  }



  // ÊûÑÂª∫ÈîÆÁõòÊåâÈíÆ
  @Builder
  buildKeyboardButton(label: string, value?: string) {
    Button(label)
      .width('30%')
      .height(48)
      .fontSize(18)
      .backgroundColor($r('app.color.card_background'))
      .fontColor($r('app.color.text_primary'))
      .borderRadius(8)
      .onClick(() => {
        this.onNumberInput(value || label)
      })
  }



  // ÊûÑÂª∫ÂàÜÁ±ªÈÄâÊã©Âô®
  @Builder
  buildCategoryPicker() {
    Column({ space: 16 }) {
      Text('ÈÄâÊã©ÂàÜÁ±ª')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      Grid() {
        ForEach(this.categories, (category: BillCategory) => {
          GridItem() {
            Column({ space: 8 }) {
              Stack() {
                 Text(category.icon)
                  .fontSize(24)
                
                // È¢úËâ≤ÊåáÁ§∫Âô®
                Circle({ width: 8, height: 8 })
                  .fill(category.color)
                  .stroke(Color.White)
                  .strokeWidth(1)
                  .position({ x: 20, y: 20 })
              }
              .width(32)
              .height(32)
              
              Text(category.name)
                .fontSize(12)
                .fontColor($r('app.color.text_primary'))
            }
            .width(60)
            .height(60)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.selectedCategory === category.name ? $r('app.color.primary_color') : $r('app.color.background_color'))
            .borderRadius(8)
            .onClick(() => {
              this.selectedCategory = category.name
              this.showCategoryPicker = false
            })
          }
        })
      }
      .columnsTemplate('1fr 1fr 1fr 1fr')
      .rowsGap(12)
      .columnsGap(12)
      .width('100%')
    }
    .padding(20)
    .backgroundColor($r('app.color.card_background'))
  }

  // ÊûÑÂª∫Ë¥¶Êà∑ÈÄâÊã©
  @Builder
  buildAccountSelector() {
    Column({ space: 8 }) {
      Text('Ë¥¶Êà∑')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .alignSelf(ItemAlign.Start)
      
      Row({ space: 8 }) {
        Text(this.selectedAccount?.name || 'ËØ∑ÈÄâÊã©Ë¥¶Êà∑')
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
        
        Text('>')
          .fontSize(16)
          .fontColor($r('app.color.text_secondary'))
      }
      .width('100%')
      .padding(12)
      .backgroundColor($r('app.color.background_color'))
      .borderRadius(8)
      .onClick(() => {
          // Á°Æ‰øùÂÖ∂‰ªñÂºπÁ™óÈÉΩÂÖ≥Èó≠
          this.showCategoryPicker = false
          // ÊòæÁ§∫Ë¥¶Êà∑ÈÄâÊã©ÂºπÁ™ó
          this.showAccountPicker = true
        })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.card_background'))
    .borderRadius(8)
    .bindSheet($$this.showAccountPicker, this.buildAccountPicker(), {
      height: 300
    })
  }

  // ÊûÑÂª∫Ë¥¶Êà∑ÈÄâÊã©Âô®
  @Builder
  buildAccountPicker() {
    Column({ space: 16 }) {
      Text('ÈÄâÊã©Ë¥¶Êà∑')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
      
      ForEach(this.accounts, (account: Account) => {
        Row({ space: 12 }) {
          Text(account.name)
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
          
          Text(`¬•${account.balance.toFixed(2)}`)
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
        }
        .width('100%')
        .padding(16)
        .backgroundColor(this.selectedAccount?.id === account.id ? $r('app.color.primary_color') : $r('app.color.background_color'))
        .borderRadius(8)
        .onClick(() => {
          this.selectedAccount = account
          this.showAccountPicker = false
        })
      })
    }
    .padding(20)
    .backgroundColor($r('app.color.card_background'))
  }

  // Ëé∑ÂèñÂàÜÁ±ªÂõæÊ†á
  private getCategoryIcon(category: string): string {
    const iconMap: Record<string, string> = {
      'È§êÈ•Æ': 'üçΩÔ∏è',
      '‰∫§ÈÄö': 'üöó',
      'Ë¥≠Áâ©': 'üõí',
      'Â®±‰πê': 'üéÆ',
      'ÂåªÁñó': 'üè•',
      'ÊïôËÇ≤': 'üìö',
      '‰ΩèÊàø': 'üè†',
      'Â∑•ËµÑ': 'üí∞',
      'Â•ñÈáë': 'üéÅ',
      'ÊäïËµÑ': 'üìà',
      'ÂÖºËÅå': 'üíº',
      'ÂÖ∂‰ªñ': 'üìù'
    }
    return iconMap[category] || 'üìù'
  }

  // Ëé∑ÂèñÂàÜÁ±ªÈ¢úËâ≤
  private getCategoryColor(category: string): string {
    const categoryObj = this.categories.find(cat => cat.name === category)
    return categoryObj?.color || '#FF6B6B'
  }
}