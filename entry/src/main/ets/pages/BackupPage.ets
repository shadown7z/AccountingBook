import { HMRouter } from '@hadss/hmrouter'
import { BackupService, BackupResult, RestoreResult, AutoBackupInfo } from '../service/BackupService'
import { PAGE_PATH } from '../constants/PagePath'
import { router } from '@kit.ArkUI'

@Entry
@HMRouter({ pageUrl: PAGE_PATH.BACKUP })
@ComponentV2
export struct BackupPage {
  @Local isLoading: boolean = false
  @Local autoBackupList: AutoBackupInfo[] = []
  @Local showBackupResult: boolean = false
  @Local showRestoreResult: boolean = false
  @Local backupResult: BackupResult | null = null
  @Local restoreResult: RestoreResult | null = null
  @Local showAutoBackupList: boolean = false
  
  private backupService = BackupService.getInstance()
  
  aboutToAppear(): void {
    this.loadAutoBackupList()
  }
  
  // åŠ è½½è‡ªåŠ¨å¤‡ä»½åˆ—è¡¨
  async loadAutoBackupList() {
    try {
      this.autoBackupList = await this.backupService.getAutoBackupList()
    } catch (error) {
      console.error('Failed to load auto backup list:', error)
    }
  }
  
  // æ‰‹åŠ¨å¤‡ä»½
  async performBackup() {
    this.isLoading = true
    try {
      const result = await this.backupService.backupAllData()
      this.backupResult = result
      this.showBackupResult = true
    } catch (error) {
      this.backupResult = {
        success: false,
        message: `å¤‡ä»½å¤±è´¥: ${error.message}`
      }
      this.showBackupResult = true
    } finally {
      this.isLoading = false
    }
  }
  
  // æ‰‹åŠ¨æ¢å¤
  async performRestore() {
    this.isLoading = true
    try {
      const result = await this.backupService.restoreData()
      this.restoreResult = result
      this.showRestoreResult = true
      
      if (result.success) {
        // æ¢å¤æˆåŠŸååˆ·æ–°æ•°æ®
        setTimeout(() => {
          this.loadAutoBackupList()
        }, 1000)
      }
    } catch (error) {
      this.restoreResult = {
        success: false,
        message: `æ¢å¤å¤±è´¥: ${error.message}`
      }
      this.showRestoreResult = true
    } finally {
      this.isLoading = false
    }
  }
  
  // è‡ªåŠ¨å¤‡ä»½
  async performAutoBackup() {
    this.isLoading = true
    try {
      const success = await this.backupService.autoBackup()
      this.backupResult = {
        success,
        message: success ? 'è‡ªåŠ¨å¤‡ä»½æˆåŠŸ' : 'è‡ªåŠ¨å¤‡ä»½å¤±è´¥'
      }
      this.showBackupResult = true
      
      if (success) {
        // å¤‡ä»½æˆåŠŸååˆ·æ–°åˆ—è¡¨
        await this.loadAutoBackupList()
      }
    } catch (error) {
      this.backupResult = {
        success: false,
        message: `è‡ªåŠ¨å¤‡ä»½å¤±è´¥: ${error.message}`
      }
      this.showBackupResult = true
    } finally {
      this.isLoading = false
    }
  }
  
  // æ¢å¤è‡ªåŠ¨å¤‡ä»½
  async restoreAutoBackup(filePath: string) {
    this.isLoading = true
    try {
      const result = await this.backupService.restoreAutoBackup(filePath)
      this.restoreResult = result
      this.showRestoreResult = true
      this.showAutoBackupList = false
    } catch (error) {
      this.restoreResult = {
        success: false,
        message: `æ¢å¤å¤±è´¥: ${error.message}`
      }
      this.showRestoreResult = true
    } finally {
      this.isLoading = false
    }
  }
  
  // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  formatFileSize(bytes: number): string {
    if (bytes < 1024) return `${bytes} B`
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸ
  formatDate(timestamp: string): string {
    const date = new Date(timestamp)
    return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
  }
  
  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button() {
          SymbolGlyph($r('sys.symbol.chevron_left'))
            .width(20)
            .height(20)
            .fontColor(['#333333'])
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back()
        })
        
        Text('æ•°æ®å¤‡ä»½')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
        
        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor($r('app.color.background_primary'))
      
      Scroll() {
        Column({ space: 16 }) {
          // å¤‡ä»½è¯´æ˜
          this.buildBackupInfo()
          
          // æ‰‹åŠ¨å¤‡ä»½
          this.buildManualBackup()
          
          // è‡ªåŠ¨å¤‡ä»½
          this.buildAutoBackup()
          
          // æ•°æ®æ¢å¤
          this.buildDataRestore()
          
          // è‡ªåŠ¨å¤‡ä»½å†å²
          this.buildAutoBackupHistory()
        }
        .padding(16)
      }
      .layoutWeight(1)
      .backgroundColor($r('app.color.background_secondary'))
    }
    .width('100%')
    .height('100%')
    .bindSheet($$this.showBackupResult, this.backupResultBuilder, {
      height: 300
    })
    .bindSheet($$this.showRestoreResult, this.restoreResultBuilder, {
      height: 300
    })
    .bindSheet($$this.showAutoBackupList, this.autoBackupListBuilder, {
      height: 500
    })
  }
  
  // å¤‡ä»½è¯´æ˜
  @Builder
  buildBackupInfo() {
    Column() {
      Row() {
        Text('ğŸ’¾')
          .fontSize(20)
          .margin({ right: 12 })
        
        Text('æ•°æ®å¤‡ä»½è¯´æ˜')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      Text('â€¢ æ‰‹åŠ¨å¤‡ä»½ï¼šå°†æ•°æ®å¯¼å‡ºåˆ°æ‚¨é€‰æ‹©çš„ä½ç½®ï¼Œå¯ç”¨äºè·¨è®¾å¤‡è¿ç§»')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 8 })
      
      Text('â€¢ è‡ªåŠ¨å¤‡ä»½ï¼šå®šæœŸåœ¨åº”ç”¨å†…éƒ¨åˆ›å»ºå¤‡ä»½ï¼Œç”¨äºæ•°æ®æ¢å¤')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .margin({ bottom: 8 })
      
      Text('â€¢ å»ºè®®å®šæœŸè¿›è¡Œå¤‡ä»½ï¼Œç¡®ä¿æ•°æ®å®‰å…¨')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.background_primary'))
    .borderRadius(12)
  }
  
  // æ‰‹åŠ¨å¤‡ä»½
  @Builder
  buildManualBackup() {
    Column() {
      Text('æ‰‹åŠ¨å¤‡ä»½')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Button('å¯¼å‡ºå¤‡ä»½æ–‡ä»¶')
        .width('100%')
        .height(48)
        .backgroundColor($r('app.color.primary_color'))
        .fontColor(Color.White)
        .borderRadius(8)
        .enabled(!this.isLoading)
        .onClick(() => {
          this.performBackup()
        })
      
      Text('å°†æ‰€æœ‰æ•°æ®å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼Œå¯ä¿å­˜åˆ°æ‚¨é€‰æ‹©çš„ä½ç½®')
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.background_primary'))
    .borderRadius(12)
  }
  
  // è‡ªåŠ¨å¤‡ä»½
  @Builder
  buildAutoBackup() {
    Column() {
      Text('è‡ªåŠ¨å¤‡ä»½')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Button('ç«‹å³åˆ›å»ºè‡ªåŠ¨å¤‡ä»½')
        .width('100%')
        .height(48)
        .backgroundColor($r('app.color.success_color'))
        .fontColor(Color.White)
        .borderRadius(8)
        .enabled(!this.isLoading)
        .onClick(() => {
          this.performAutoBackup()
        })
      
      Text('åœ¨åº”ç”¨å†…éƒ¨åˆ›å»ºå¤‡ä»½ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿ç•™æœ€è¿‘7ä¸ªå¤‡ä»½æ–‡ä»¶')
        .fontSize(12)
        .fontColor($r('app.color.text_secondary'))
        .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.background_primary'))
    .borderRadius(12)
  }
  
  // æ•°æ®æ¢å¤
  @Builder
  buildDataRestore() {
    Column() {
      Text('æ•°æ®æ¢å¤')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Button('ä»æ–‡ä»¶æ¢å¤')
        .width('100%')
        .height(48)
        .backgroundColor($r('app.color.warning_color'))
        .fontColor(Color.White)
        .borderRadius(8)
        .enabled(!this.isLoading)
        .onClick(() => {
          this.performRestore()
        })
      
      Text('âš ï¸ æ¢å¤æ•°æ®å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œ')
        .fontSize(12)
        .fontColor($r('app.color.warning_color'))
        .margin({ top: 8 })
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.background_primary'))
    .borderRadius(12)
  }
  
  // è‡ªåŠ¨å¤‡ä»½å†å²
  @Builder
  buildAutoBackupHistory() {
    Column() {
      Row() {
        Text('è‡ªåŠ¨å¤‡ä»½å†å²')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)
        
        Button('æŸ¥çœ‹å…¨éƒ¨')
          .backgroundColor(Color.Transparent)
          .fontColor($r('app.color.primary_color'))
          .fontSize(14)
          .onClick(() => {
            this.showAutoBackupList = true
          })
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      if (this.autoBackupList.length > 0) {
        ForEach(this.autoBackupList.slice(0, 3), (backup: AutoBackupInfo) => {
          Row() {
            Column() {
              Text(this.formatDate(backup.timestamp))
                .fontSize(14)
                .fontColor($r('app.color.text_primary'))
              Text(`${this.formatFileSize(backup.size)} â€¢ v${backup.version}`)
                .fontSize(12)
                .fontColor($r('app.color.text_secondary'))
                .margin({ top: 2 })
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
            
            Button('æ¢å¤')
              .backgroundColor($r('app.color.primary_color'))
              .fontColor(Color.White)
              .fontSize(12)
              .borderRadius(6)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .enabled(!this.isLoading)
              .onClick(() => {
                this.restoreAutoBackup(backup.filePath)
              })
          }
          .width('100%')
          .padding({ top: 12, bottom: 12 })
          .borderRadius(8)
          .backgroundColor($r('app.color.background_secondary'))
          .margin({ bottom: 8 })
        })
      } else {
        Text('æš‚æ— è‡ªåŠ¨å¤‡ä»½è®°å½•')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .width('100%')
          .padding(20)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.background_primary'))
    .borderRadius(12)
  }
  
  // å¤‡ä»½ç»“æœå¼¹çª—
  @Builder
  backupResultBuilder() {
    Column() {
      Text(this.backupResult?.success ? 'âœ… å¤‡ä»½æˆåŠŸ' : 'âŒ å¤‡ä»½å¤±è´¥')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 20 })
      
      Text(this.backupResult?.message || '')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })
      
      if (this.backupResult?.success && this.backupResult.dataCount) {
        Column() {
          Text(`è´¦å•è®°å½•: ${this.backupResult.dataCount.bills}æ¡`)
            .fontSize(14)
            .margin({ bottom: 4 })
          Text(`è´¦æˆ·ä¿¡æ¯: ${this.backupResult.dataCount.accounts}ä¸ª`)
            .fontSize(14)
            .margin({ bottom: 4 })
          Text(`é¢„ç®—è®¾ç½®: ${this.backupResult.dataCount.budgets}ä¸ª`)
            .fontSize(14)
        }
        .margin({ bottom: 20 })
      }
      
      Button('ç¡®å®š')
        .backgroundColor($r('app.color.primary_color'))
        .fontColor(Color.White)
        .onClick(() => {
          this.showBackupResult = false
        })
    }
    .padding(20)
  }
  
  // æ¢å¤ç»“æœå¼¹çª—
  @Builder
  restoreResultBuilder() {
    Column() {
      Text(this.restoreResult?.success ? 'âœ… æ¢å¤æˆåŠŸ' : 'âŒ æ¢å¤å¤±è´¥')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 20 })
      
      Text(this.restoreResult?.message || '')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .textAlign(TextAlign.Center)
        .margin({ bottom: 20 })
      
      if (this.restoreResult?.success && this.restoreResult.dataCount) {
        Column() {
          Text(`æ¢å¤è´¦å•è®°å½•: ${this.restoreResult.dataCount.bills}æ¡`)
            .fontSize(14)
            .margin({ bottom: 4 })
          Text(`æ¢å¤è´¦æˆ·ä¿¡æ¯: ${this.restoreResult.dataCount.accounts}ä¸ª`)
            .fontSize(14)
            .margin({ bottom: 4 })
          Text(`æ¢å¤é¢„ç®—è®¾ç½®: ${this.restoreResult.dataCount.budgets}ä¸ª`)
            .fontSize(14)
            .margin({ bottom: 4 })
          
          if (this.restoreResult.backupDate) {
            Text(`å¤‡ä»½æ—¶é—´: ${this.formatDate(this.restoreResult.backupDate)}`)
              .fontSize(12)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 8 })
          }
        }
        .margin({ bottom: 20 })
      }
      
      Button('ç¡®å®š')
        .backgroundColor($r('app.color.primary_color'))
        .fontColor(Color.White)
        .onClick(() => {
          this.showRestoreResult = false
        })
    }
    .padding(20)
  }
  
  // è‡ªåŠ¨å¤‡ä»½åˆ—è¡¨å¼¹çª—
  @Builder
  autoBackupListBuilder() {
    Column() {
      Text('è‡ªåŠ¨å¤‡ä»½å†å²')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 20 })
      
      if (this.autoBackupList.length > 0) {
        Scroll() {
          Column() {
            ForEach(this.autoBackupList, (backup: AutoBackupInfo) => {
              Row() {
                Column() {
                  Text(this.formatDate(backup.timestamp))
                    .fontSize(14)
                    .fontColor($r('app.color.text_primary'))
                  Text(`${this.formatFileSize(backup.size)} â€¢ v${backup.version}`)
                    .fontSize(12)
                    .fontColor($r('app.color.text_secondary'))
                    .margin({ top: 2 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                
                Button('æ¢å¤')
                  .backgroundColor($r('app.color.primary_color'))
                  .fontColor(Color.White)
                  .fontSize(12)
                  .borderRadius(6)
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                  .enabled(!this.isLoading)
                  .onClick(() => {
                    this.restoreAutoBackup(backup.filePath)
                  })
              }
              .width('100%')
              .padding(12)
              .borderRadius(8)
              .backgroundColor($r('app.color.background_secondary'))
              .margin({ bottom: 8 })
            })
          }
        }
        .layoutWeight(1)
      } else {
        Text('æš‚æ— è‡ªåŠ¨å¤‡ä»½è®°å½•')
          .fontSize(14)
          .fontColor($r('app.color.text_secondary'))
          .textAlign(TextAlign.Center)
          .layoutWeight(1)
      }
      
      Button('å…³é—­')
        .backgroundColor($r('app.color.background_secondary'))
        .fontColor($r('app.color.text_primary'))
        .margin({ top: 20 })
        .onClick(() => {
          this.showAutoBackupList = false
        })
    }
    .padding(20)
    .height('100%')
  }
}